{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user in the EcoTrack application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user entity."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "name": {
          "type": "string",
          "description": "User's full name."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "name",
        "createdAt"
      ]
    },
    "Activity": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Activity",
      "type": "object",
      "description": "Represents a user-logged activity that contributes to their carbon footprint.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the activity entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Activity)"
        },
        "type": {
          "type": "string",
          "description": "Type of activity (e.g., transport, electricity, diet, shopping)."
        },
        "details": {
          "type": "string",
          "description": "Details about the activity, stored as a string."
        },
        "emission": {
          "type": "number",
          "description": "The amount of carbon emission from the activity."
        },
        "date": {
          "type": "string",
          "description": "Date the activity occurred.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "userId",
        "type",
        "details",
        "emission",
        "date"
      ]
    },
    "EmissionFactor": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "EmissionFactor",
      "type": "object",
      "description": "Represents the carbon emission factor for a specific activity type.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the emission factor entity."
        },
        "activityType": {
          "type": "string",
          "description": "The activity type this emission factor applies to (e.g., transport_car, electricity)."
        },
        "factor": {
          "type": "number",
          "description": "The emission factor value (e.g., kg CO2 per kWh)."
        },
        "unit": {
          "type": "string",
          "description": "The unit of measure for the emission factor (e.g., kWh, km)."
        }
      },
      "required": [
        "id",
        "activityType",
        "factor",
        "unit"
      ]
    },
    "DailyAggregate": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "DailyAggregate",
      "type": "object",
      "description": "Aggregated carbon emission data for a user on a specific day.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the daily aggregate entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N DailyAggregate)"
        },
        "date": {
          "type": "string",
          "description": "The date for which the emissions are aggregated.",
          "format": "date-time"
        },
        "totalEmission": {
          "type": "number",
          "description": "Total carbon emission for the user on that day."
        }
      },
      "required": [
        "id",
        "userId",
        "date",
        "totalEmission"
      ]
    },
    "GamificationState": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "GamificationState",
      "type": "object",
      "description": "Represents a users gamification progress.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the gamification state entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:1 GamificationState)"
        },
        "badges": {
          "type": "array",
          "description": "List of earned badges",
          "items": {
            "type": "string"
          }
        },
        "streak": {
          "type": "number",
          "description": "Current streak of consecutive days with activity logging."
        },
        "level": {
          "type": "number",
          "description": "User's current level in the gamification system."
        }
      },
      "required": [
        "id",
        "userId",
        "badges",
        "streak",
        "level"
      ]
    },
    "Recommendation": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Recommendation",
      "type": "object",
      "description": "Represents a recommendation for reducing carbon footprint.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the recommendation entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Recommendation)"
        },
        "text": {
          "type": "string",
          "description": "Text of the recommendation (e.g., 'Use public transport twice a week')."
        },
        "category": {
          "type": "string",
          "description": "Category of the recommendation (e.g., transport, energy, food)."
        },
        "reasoning": {
          "type": "string",
          "description": "Justification to provide why that suggestion was given."
        }
      },
      "required": [
        "id",
        "userId",
        "text",
        "category",
        "reasoning"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile information. Uses path-based ownership for security.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/activities/{activityId}",
        "definition": {
          "entityName": "Activity",
          "schema": {
            "$ref": "#/backend/entities/Activity"
          },
          "description": "Stores user activities contributing to their carbon footprint. Uses path-based ownership for security.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "activityId",
              "description": "The unique identifier for the activity."
            }
          ]
        }
      },
      {
        "path": "/emissionFactors/{emissionFactorId}",
        "definition": {
          "entityName": "EmissionFactor",
          "schema": {
            "$ref": "#/backend/entities/EmissionFactor"
          },
          "description": "Stores the emission factors for different activity types.",
          "params": [
            {
              "name": "emissionFactorId",
              "description": "The unique identifier for the emission factor."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/dailyAggregates/{dailyAggregateId}",
        "definition": {
          "entityName": "DailyAggregate",
          "schema": {
            "$ref": "#/backend/entities/DailyAggregate"
          },
          "description": "Stores daily aggregated carbon emission data for each user. Uses path-based ownership for security.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "dailyAggregateId",
              "description": "The unique identifier for the daily aggregate data."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/gamificationState",
        "definition": {
          "entityName": "GamificationState",
          "schema": {
            "$ref": "#/backend/entities/GamificationState"
          },
          "description": "Stores gamification state for each user. Uses path-based ownership for security.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/recommendations/{recommendationId}",
        "definition": {
          "entityName": "Recommendation",
          "schema": {
            "$ref": "#/backend/entities/Recommendation"
          },
          "description": "Stores personalized recommendations for each user. Uses path-based ownership for security.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user."
            },
            {
              "name": "recommendationId",
              "description": "The unique identifier for the recommendation."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to provide a secure and scalable data model for the EcoTrack application, adhering to the principles of Authorization Independence, Clarity of Intent, DBAC, and QAPs. The structure prioritizes path-based ownership for user-specific data and membership maps for collaborative data access.\n\n*   **Authorization Independence:**  Denormalization is heavily used. For example, the `Activity` documents are stored as a subcollection of `users`. This structure enables simple security rules based on `request.auth.uid` without needing to `get()` parent documents. No `get()` calls in rules are necessary.\n*   **Structural Segregation:**  All documents within a collection share the same security requirements. All user data is nested under `/users/{userId}`, and emission factors are stored in a separate collection.\n*   **Access Modeling:**  Path-based ownership is used for `users/{userId}/activities/{activityId}`, `users/{userId}/dailyAggregates/{dailyAggregateId}`, and `users/{userId}/recommendations/{recommendationId}`. The `User` document itself leverages path-based ownership at `/users/{userId}`. Gamification state uses path based ownership under `/users/{userId}/gamificationState`.\n*   **QAPs:** This structure allows secure list operations. For example, listing activities for a specific user is done through the `/users/{userId}/activities` collection, which can be secured with a rule that only allows the authenticated user to access their own activities.\n\nThis design ensures that security rules are straightforward and efficient, minimizing the risk of vulnerabilities and maximizing the performance of the application."
  }
}